<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–Ø–¥—Ä–æ-–¶–µ–Ω—Ç—Ä</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* –¢–í–û–Ø –ü–ê–õ–ò–¢–†–ê */
            --bg-orange: #FE6B35;    /* –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–æ–Ω */
            --el-white: #F5F6F9;     /* –ü–ª–∞—à–∫–∏, –∏–Ω–ø—É—Ç—ã (–µ—Å–ª–∏ –±–µ–ª—ã–µ), —Ñ–æ–Ω –º–µ–Ω—é */
            --text-black: #1A1A1A;   /* –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
            --accent-beige: #F4E1D2; /* –§–æ–Ω –¥–ª—è —Å–µ—Ä–¥–µ—á–∫–∞ */
            
            --border-dashed: 2px dashed #1A1A1A; /* –§–∏—Ä–º–µ–Ω–Ω–∞—è –æ–±–≤–æ–¥–∫–∞ */
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-orange);
            color: var(--text-black);
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- –û–ë–©–ò–ô –°–¢–ò–õ–¨ –í–ï–†–•–ù–ï–ô "–®–¢–û–†–ö–ò" (HEADER) --- */
        .top-capsule {
            background-color: var(--el-white);
            margin: 20px;
            padding: 12px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 50px;
            position: relative; /* –ß—Ç–æ–±—ã z-index —Ä–∞–±–æ—Ç–∞–ª */
            z-index: 100;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* –ï—Å–ª–∏ —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–Ω–∞ —ç–∫—Ä–∞–Ω–µ –≤—Ö–æ–¥–∞) */
        .top-capsule.center-text {
            justify-content: center;
            font-weight: 800;
            font-size: 18px;
        }

        .logo { 
            font-size: 20px; 
            font-weight: 800; 
            color: var(--text-black); 
        }

        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ø—Ä–∞–≤–∞ –≤ —à–∞–ø–∫–µ (–¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞) */
        .header-right { 
            position: relative; 
            display: flex; 
            align-items: center; 
        }

        /* –ê–í–ê–¢–ê–† */
        .user-avatar {
            width: 42px; 
            height: 42px;
            background: #000;
            color: #fff;
            border-radius: 50%;
            display: none; /* Flex –∫–æ–≥–¥–∞ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω */
            justify-content: center;
            align-items: center;
            font-weight: 900;
            font-size: 16px;
            cursor: pointer;
            background-size: cover;
            background-position: center;
            border: 2px solid #fff;
            transition: transform 0.2s;
        }
        .user-avatar:hover { transform: scale(1.05); }

        /* --- –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò --- */
        #auth-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg-orange);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-y: auto;
        }

        /* –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏, —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
        .auth-content-wrapper {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding-bottom: 60px; /* –ö–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è —à–∞–ø–∫–∏ */
        }

        .auth-card {
            width: 90%;
            max-width: 380px;
            background: var(--el-white);
            padding: 40px 30px;
            border-radius: 45px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        }

        .auth-card h2 {
            font-size: 26px;
            font-weight: 900;
            margin-bottom: 30px;
            margin-top: 0;
            color: var(--text-black);
        }

        /* –°–¢–ò–õ–ò –ò–ù–ü–£–¢–û–í –ò –ö–ù–û–ü–û–ö (–ö–ê–ö –¢–´ –ü–†–û–°–ò–õ) */
        input {
            width: 100%;
            padding: 16px 20px;
            border: var(--border-dashed);
            border-radius: 30px;
            margin-bottom: 15px;
            font-family: inherit;
            font-weight: 700;
            box-sizing: border-box;
            background: var(--bg-orange); /* –û—Ä–∞–Ω–∂–µ–≤—ã–π —Ñ–æ–Ω –≤–Ω—É—Ç—Ä–∏ */
            color: var(--text-black);
            font-size: 14px;
            outline: none;
        }
        
        input::placeholder { color: rgba(26, 26, 26, 0.6); }

        .btn-action {
            width: 100%;
            padding: 16px;
            background: var(--bg-orange);
            color: var(--text-black);
            border: var(--border-dashed);
            border-radius: 30px;
            font-weight: 800;
            cursor: pointer;
            transition: 0.3s;
            display: flex; justify-content: center; align-items: center;
            font-size: 15px;
            margin-top: 10px;
        }
        
        .btn-action:hover {
            background: #ff855e;
            transform: translateY(-2px);
        }

        /* –ë–ª–æ–∫ "–ú—ã –∑–∞—â–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ" */
        .data-protect {
            background: #fff; /* –ë–µ–ª—ã–π —Ñ–æ–Ω –¥–ª—è –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏ */
            border-radius: 20px;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            text-align: left;
        }
        .heart-icon-box {
            width: 36px; height: 36px;
            background: var(--accent-beige); /* –¢–≤–æ–π –±–µ–∂–µ–≤—ã–π */
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            color: var(--bg-orange);
        }

        .switch-link {
            font-weight: 800; 
            text-decoration: underline; 
            cursor: pointer;
        }

        /* --- –ì–õ–ê–í–ù–ê–Ø –°–¢–†–ê–ù–ò–¶–ê --- */
        main { 
            display: none; 
            opacity: 0; 
            transition: 0.5s; 
        }

        /* HERO SECTION - –ü–†–ò–í–ï–¢–°–¢–í–ò–ï –í–û –í–ï–°–¨ –≠–ö–†–ê–ù */
        .hero-section {
            min-height: 80vh; /* –ü–æ—á—Ç–∏ –≤–µ—Å—å —ç–∫—Ä–∞–Ω, —É—á–∏—Ç—ã–≤–∞—è —à–∞–ø–∫—É */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 0 20px;
        }

        .hero-title {
            font-size: clamp(40px, 8vw, 64px); /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä */
            font-weight: 900;
            margin-bottom: 20px;
            color: var(--text-black);
        }
        
        .hero-desc {
            max-width: 750px;
            font-size: 16px;
            font-weight: 600;
            line-height: 1.6;
            margin-bottom: 50px;
        }

        /* –°–µ–∫—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (–∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –Ω–∏–∂–µ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ) */
        .content-section {
            padding: 40px 20px;
            min-height: 50vh;
        }

        /* --- –í–´–ü–ê–î–ê–Æ–©–ï–ï –ú–ï–ù–Æ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–û–ï) --- */
        .user-menu {
            position: absolute; 
            top: 55px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –≤–µ—Ä—Ö–∞ —à–∞–ø–∫–∏ */
            right: 0;
            width: 250px;
            background: var(--el-white);
            border-radius: 25px;
            padding: 10px;
            display: none; 
            flex-direction: column;
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
            z-index: 1100;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .user-menu.active { display: flex; animation: menuFade 0.2s ease-out; }
        @keyframes menuFade { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .menu-header {
            padding: 10px 15px;
            margin-bottom: 5px;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }

        .menu-item {
            padding: 12px 15px; 
            font-weight: 700; 
            border-radius: 15px; 
            cursor: pointer; 
            display: flex; 
            gap: 12px; 
            align-items: center;
            font-size: 13px; 
            transition: 0.2s;
            color: var(--text-black);
        }
        .menu-item:hover { background: rgba(0,0,0,0.05); }
        .menu-item svg { width: 18px; height: 18px; stroke-width: 2.5px; opacity: 0.7; }
        .menu-item:hover svg { opacity: 1; }

        /* --- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 26, 26, 0.6); backdrop-filter: blur(5px);
            z-index: 3000; display: none; justify-content: center; align-items: center;
        }
        .modal-window {
            background: var(--el-white); width: 90%; max-width: 400px; padding: 30px;
            border-radius: 40px; position: relative; display: flex; flex-direction: column;
        }
        .modal-close { position: absolute; top: 20px; right: 20px; cursor: pointer; opacity: 0.5; }
        .modal-close:hover { opacity: 1; }

        /* UI Utils */
        .loader {
            width: 18px; height: 18px; border: 2px solid var(--text-black); border-bottom-color: transparent;
            border-radius: 50%; animation: rotation 1s linear infinite; display: inline-block;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div id="custom-modal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-close" id="modal-close-btn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1A1A1A" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </div>
            <div id="modal-title" style="font-size: 22px; font-weight: 900; margin-bottom: 10px;"></div>
            <div id="modal-content"></div>
            <button class="btn-action" id="modal-action-btn" style="background:#1A1A1A; color:#fff; border:none; margin-top:20px;">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>

    <div id="auth-screen">
        <div style="width: 100%;">
            <div class="top-capsule center-text">
                –Ø–¥—Ä–æ-–ó–∞—â–∏—Ç–∞
            </div>
        </div>
        
        <div class="auth-content-wrapper">
            <div class="auth-card">
                <h2 id="auth-title">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                
                <input type="email" id="email" placeholder="–ü–æ—á—Ç–∞">
                <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
                
                <div id="error-msg" style="color:#d32f2f; font-size:12px; margin-bottom: 10px; font-weight: 700;"></div>

                <div class="data-protect">
                    <div class="heart-icon-box">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                    </div>
                    <div style="font-size: 12px; font-weight: 700; line-height: 1.2; color: #000;">
                        –ú—ã –∑–∞—â–∏—â–∞–µ–º –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ
                    </div>
                </div>

                <div style="margin-bottom: 20px; font-size: 14px; font-weight: 600;">
                    <span id="switch-text">—É–∂–µ –≤ —Å–∏—Å—Ç–µ–º–µ?</span> 
                    <span id="switch-auth" class="switch-link">–≤–æ–π—Ç–∏</span>
                </div>

                <button class="btn-action" id="auth-btn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
    </div>

    <header class="top-capsule" id="main-header" style="display:none;">
        <div class="logo">–Ø–¥—Ä–æ-–¶–µ–Ω—Ç—Ä</div>
        
        <div class="header-right">
            <div class="user-avatar" id="avatar"></div>

            <div class="user-menu" id="user-menu">
                <div class="menu-header">
                    <div style="font-weight:800; font-size:16px; overflow:hidden; text-overflow:ellipsis;" id="menu-user-display">...</div>
                    <div style="font-size:11px; opacity:0.5; margin-top:2px;" id="menu-user-date">...</div>
                </div>
                
                <div class="menu-item" id="btn-edit-profile">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    –ü—Ä–æ—Ñ–∏–ª—å
                </div>
                <div class="menu-item" id="btn-verify-email" style="display:none;">
                     <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ—á—Ç—É
                </div>
                <div class="menu-item" id="btn-change-email">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    –°–º–µ–Ω–∏—Ç—å –ø–æ—á—Ç—É
                </div>
                <div class="menu-item" id="btn-sessions">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line></svg>
                    –°–µ—Å—Å–∏–∏
                </div>
                <div class="menu-item" id="btn-change-pass">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    –ü–∞—Ä–æ–ª—å
                </div>
                <div style="height:1px; background:rgba(0,0,0,0.1); margin:6px 0;"></div>
                <div class="menu-item" id="logout-btn" style="color:#d32f2f;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                    –í—ã–π—Ç–∏
                </div>
                <div class="menu-item" id="btn-delete-acc" style="opacity: 0.5; font-size: 11px;">
                    –£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                </div>
            </div>
            
            <svg id="verified-icon" style="display:none; color: var(--text-black); margin-right: 10px;" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
        </div>
    </header>

    <main id="main-content">
        <div class="hero-section">
            <h1 class="hero-title">–ó–¥—Ä–∞—Å—Ç–≤—É–π—Ç–µ!</h1>
            <p class="hero-desc">
                –ú—ã —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ–µ–∫—Ç—ã –∫–æ—Ç–æ—Ä—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ –æ–±–ª–µ–≥—á–∞—Ç –≤–∞–º –∂–∏–∑–Ω—å, –º—ã –æ–±–µ—â–∞–µ–º –≤–∞–º, —á—Ç–æ –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã
                –∫–æ—Ç–æ—Ä—ã–µ –º—ã —Å–¥–µ–ª–∞–ª–∏, –±—É–¥—É—Ç —Ö–æ—Ä–æ—à–µ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞.<br><br>
                –°–ø–∞—Å–∏–±–æ –∑–∞ –¥–æ–≤–µ—Ä–∏–µ!<br>
                –ú—ã –Ω–µ –ø–æ–¥–≤–µ–¥—ë–º... –Ω–∞–¥–µ–µ–º—Å—è —á—Ç–æ –Ω–µ –ø–æ–¥–≤–µ–¥—ë–º.
            </p>
            <div style="opacity: 0.5; font-size: 14px; font-weight: 700; margin-top: 20px;">
                –õ–∏—Å—Ç–∞–π—Ç–µ –≤–Ω–∏–∑ ‚Üì
            </div>
        </div>

        <div class="content-section">
            </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { 
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
            onAuthStateChanged, signOut, updateProfile, updatePassword, 
            deleteUser, EmailAuthProvider, reauthenticateWithCredential,
            sendEmailVerification, updateEmail
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD44R3ysKNa0LBYMXmUmLNh_qodZW_hIgA",
            authDomain: "yadro-66837.firebaseapp.com",
            projectId: "yadro-66837",
            storageBucket: "yadro-66837.firebasestorage.app",
            messagingSenderId: "832600606184",
            appId: "1:832600606184:web:32e1b7f63b147fd6ad505d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        const authScreen = document.getElementById('auth-screen');
        const mainContent = document.getElementById('main-content');
        const mainHeader = document.getElementById('main-header');
        const authBtn = document.getElementById('auth-btn');
        const avatar = document.getElementById('avatar');
        const userMenu = document.getElementById('user-menu');
        const modal = document.getElementById('custom-modal');
        const modalContent = document.getElementById('modal-content');
        const modalActionBtn = document.getElementById('modal-action-btn');
        const verifiedIcon = document.getElementById('verified-icon');
        const verifyBtn = document.getElementById('btn-verify-email');

        let isLoginMode = false; 
        let currentAction = null;
        let deleteStep = 1;

        // UI UTILS
        function setBtnLoading(btn, isLoading, text = "–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å") {
            if(isLoading) {
                btn.disabled = true;
                btn.innerHTML = `<span class="loader"></span>`;
            } else {
                btn.disabled = false;
                btn.innerHTML = text;
            }
        }

        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let os = "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ";
            let browser = "–ë—Ä–∞—É–∑–µ—Ä";
            if (ua.indexOf("Win") != -1) os = "Windows";
            if (ua.indexOf("Mac") != -1) os = "Macintosh";
            if (ua.indexOf("Linux") != -1) os = "Linux";
            if (ua.indexOf("Android") != -1) os = "Android";
            if (ua.indexOf("like Mac") != -1) os = "iOS";
            if (ua.indexOf("Chrome") != -1) browser = "Chrome";
            else if (ua.indexOf("Firefox") != -1) browser = "Firefox";
            else if (ua.indexOf("Safari") != -1) browser = "Safari";
            else if (ua.indexOf("Edge") != -1) browser = "Edge";
            return { os, browser };
        }

        function updateAvatarUI(user) {
            const name = user.displayName || user.email.split('@')[0];
            document.getElementById('menu-user-display').innerText = name;
            
            if(user.photoURL) {
                avatar.textContent = "";
                avatar.style.backgroundImage = `url('${user.photoURL}')`;
            } else {
                avatar.style.backgroundImage = "none";
                avatar.textContent = name.charAt(0).toUpperCase();
            }

            if(user.emailVerified) {
                verifiedIcon.classList.add('active');
                verifyBtn.style.display = 'none';
            } else {
                verifiedIcon.classList.remove('active');
                verifyBtn.style.display = 'flex';
            }
        }

        // FIREBASE LOGIC
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authScreen.style.opacity = '0';
                setTimeout(() => authScreen.style.display = 'none', 500);
                
                mainHeader.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —à–∞–ø–∫—É
                mainContent.style.display = 'block';
                setTimeout(() => mainContent.style.opacity = '1', 50);
                
                avatar.style.display = 'flex';
                
                const creationDate = user.metadata.creationTime ? new Date(user.metadata.creationTime) : new Date();
                const dateStr = creationDate.toLocaleDateString('ru-RU');
                document.getElementById('menu-user-date').innerText = `–í —Å–∏—Å—Ç–µ–º–µ —Å ${dateStr}`;

                updateAvatarUI(user);
            } else {
                mainContent.style.opacity = '0';
                setTimeout(() => mainContent.style.display = 'none', 500);
                mainHeader.style.display = 'none'; // –°–∫—Ä—ã–≤–∞–µ–º —à–∞–ø–∫—É

                authScreen.style.display = 'flex';
                setTimeout(() => authScreen.style.opacity = '1', 50);
                avatar.style.display = 'none';
                userMenu.classList.remove('active');
                
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                document.getElementById('error-msg').innerText = '';
            }
        });

        document.getElementById('switch-auth').addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            document.getElementById('auth-title').innerText = isLoginMode ? '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è' : '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
            authBtn.innerText = isLoginMode ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
            document.getElementById('switch-text').innerText = isLoginMode ? '–Ω–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞?' : '—É–∂–µ –≤ —Å–∏—Å—Ç–µ–º–µ?';
            document.getElementById('switch-auth').innerText = isLoginMode ? '—Å–æ–∑–¥–∞—Ç—å' : '–≤–æ–π—Ç–∏';
        });

        authBtn.addEventListener('click', async () => {
            const email = document.getElementById('email').value.trim();
            const pass = document.getElementById('password').value;
            setBtnLoading(authBtn, true);
            
            try {
                if(isLoginMode) await signInWithEmailAndPassword(auth, email, pass);
                else await createUserWithEmailAndPassword(auth, email, pass);
            } catch (e) {
                let msg = "–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞";
                if(e.code === 'auth/wrong-password') msg = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
                if(e.code === 'auth/user-not-found') msg = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω";
                if(e.code === 'auth/email-already-in-use') msg = "–ü–æ—á—Ç–∞ —É–∂–µ –∑–∞–Ω—è—Ç–∞";
                if(e.code === 'auth/weak-password') msg = "–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –ø—Ä–æ—Å—Ç–æ–π";
                document.getElementById('error-msg').innerText = msg;
            } finally {
                setBtnLoading(authBtn, false, isLoginMode ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è');
            }
        });

        // MODAL & ACTIONS
        window.closeModalCustom = () => {
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; currentAction = null; deleteStep = 1; }, 300);
        };

        function openModal(type) {
            currentAction = type;
            modal.style.display = 'flex';
            document.getElementById('error-msg').innerText = ""; 
            setTimeout(() => modal.classList.add('open'), 10);
            
            if(type === 'delete') {
                deleteStep = 1;
                document.getElementById('modal-title').innerText = "–£–¥–∞–ª–µ–Ω–∏–µ";
                setBtnLoading(modalActionBtn, false, "–î–∞, —É–¥–∞–ª–∏—Ç—å");
                modalContent.innerHTML = `<p style="font-weight: 700; text-align: center;">–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç?</p>`;
            }
            if(type === 'profile') {
                document.getElementById('modal-title').innerText = "–ü—Ä–æ—Ñ–∏–ª—å";
                setBtnLoading(modalActionBtn, false, "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å");
                modalContent.innerHTML = `<input type="text" id="m-name" placeholder="–ù–æ–≤–æ–µ –∏–º—è" value="${auth.currentUser.displayName || ''}"><input type="text" id="m-url" placeholder="URL —Ñ–æ—Ç–æ" value="${auth.currentUser.photoURL || ''}">`;
            }
            if(type === 'password') {
                document.getElementById('modal-title').innerText = "–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å";
                setBtnLoading(modalActionBtn, false, "–û–±–Ω–æ–≤–∏—Ç—å");
                modalContent.innerHTML = `<input type="password" id="m-new-pass" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">`;
            }
            if(type === 'email_change') {
                deleteStep = 1;
                document.getElementById('modal-title').innerText = "–°–º–µ–Ω–∞ –ø–æ—á—Ç—ã";
                setBtnLoading(modalActionBtn, false, "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å");
                modalContent.innerHTML = `<p style="font-size:13px; opacity:0.6; text-align:center;">–¢–µ–∫—É—â–∞—è: ${auth.currentUser.email}</p><input type="email" id="m-new-email" placeholder="–ù–æ–≤–∞—è –ø–æ—á—Ç–∞">`;
            }
            if(type === 'sessions') {
                const device = getDeviceInfo();
                document.getElementById('modal-title').innerText = "–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞";
                setBtnLoading(modalActionBtn, false, "–°–±—Ä–æ—Å–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ");
                modalContent.innerHTML = `
                    <div style="background:#f5f5f7; border-radius:15px; padding:15px; display:flex; align-items:center; gap:15px;">
                        <div style="font-size:24px;">üíª</div>
                        <div>
                            <div style="font-weight:800; font-size:14px;">${device.os} / ${device.browser}</div>
                            <div style="font-size:11px; opacity:0.5;">–ê–∫—Ç–∏–≤–Ω–æ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å</div>
                        </div>
                    </div>`;
            }
            if(type === 'verify') {
                document.getElementById('modal-title').innerText = "–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è";
                setBtnLoading(modalActionBtn, false, "–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–æ");
                modalContent.innerHTML = `<p style="text-align:center;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ <b>${auth.currentUser.email}</b>?</p>`;
            }
        }

        modalActionBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            const originalBtnText = modalActionBtn.innerText;
            setBtnLoading(modalActionBtn, true);
            
            try {
                if(currentAction === 'profile') {
                    const newName = document.getElementById('m-name').value;
                    const newUrl = document.getElementById('m-url').value;
                    await updateProfile(user, { displayName: newName, photoURL: newUrl });
                    updateAvatarUI(user);
                    closeModalCustom();
                }

                if(currentAction === 'delete') {
                    if(deleteStep === 1) {
                        deleteStep = 2;
                        document.getElementById('modal-title').innerText = "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ";
                        setBtnLoading(modalActionBtn, false, "–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞");
                        modalContent.innerHTML = `<input type="password" id="confirm-pass" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">`;
                        return;
                    }
                    const pass = document.getElementById('confirm-pass').value;
                    const credential = EmailAuthProvider.credential(user.email, pass);
                    await reauthenticateWithCredential(user, credential);
                    await deleteUser(user);
                    closeModalCustom();
                }

                if(currentAction === 'password') {
                    const newPass = document.getElementById('m-new-pass').value;
                    if(newPass.length < 6) throw new Error("–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤");
                    await updatePassword(user, newPass);
                    alert("–ü–∞—Ä–æ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω");
                    closeModalCustom();
                }

                if(currentAction === 'email_change') {
                    if(deleteStep === 1) {
                        const newEmail = document.getElementById('m-new-email').value;
                        if(!newEmail.includes('@')) throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ø–æ—á—Ç–∞");
                        modal.dataset.tempEmail = newEmail;
                        deleteStep = 2;
                        setBtnLoading(modalActionBtn, false, "–°–º–µ–Ω–∏—Ç—å –ø–æ—á—Ç—É");
                        modalContent.innerHTML = `<input type="password" id="confirm-pass-email" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è">`;
                        return;
                    }
                    const pass = document.getElementById('confirm-pass-email').value;
                    const credential = EmailAuthProvider.credential(user.email, pass);
                    await reauthenticateWithCredential(user, credential);
                    await updateEmail(user, modal.dataset.tempEmail);
                    alert("–ü–æ—á—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∞!");
                    closeModalCustom();
                }

                if(currentAction === 'verify') {
                    await sendEmailVerification(user);
                    alert("–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!");
                    closeModalCustom();
                }

                if(currentAction === 'sessions') {
                     if(deleteStep === 1) {
                         deleteStep = 2;
                         modalContent.innerHTML += `<div style="margin-top:10px;"><input type="password" id="sess-pass" placeholder="–ü–∞—Ä–æ–ª—å"></div>`;
                         setBtnLoading(modalActionBtn, false, "–°–±—Ä–æ—Å–∏—Ç—å");
                         return;
                     }
                    const pass = document.getElementById('sess-pass').value;
                    const credential = EmailAuthProvider.credential(user.email, pass);
                    await reauthenticateWithCredential(user, credential);
                    alert("–°–±—Ä–æ—à–µ–Ω–æ.");
                    closeModalCustom();
                }

            } catch(e) {
                console.error(e);
                alert("–û—à–∏–±–∫–∞: " + e.message);
                if(currentAction === 'delete' || currentAction === 'sessions' || currentAction === 'email_change') deleteStep = 1;
            } finally {
                if(modal.style.display !== 'none') {
                    setBtnLoading(modalActionBtn, false, originalBtnText);
                }
            }
        });

        // Listeners
        avatar.addEventListener('click', () => userMenu.classList.toggle('active'));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        document.getElementById('btn-edit-profile').addEventListener('click', () => openModal('profile'));
        document.getElementById('btn-delete-acc').addEventListener('click', () => openModal('delete'));
        document.getElementById('btn-change-pass').addEventListener('click', () => openModal('password'));
        document.getElementById('btn-sessions').addEventListener('click', () => openModal('sessions'));
        document.getElementById('btn-verify-email').addEventListener('click', () => openModal('verify'));
        document.getElementById('btn-change-email').addEventListener('click', () => openModal('email_change'));
        document.getElementById('modal-close-btn').addEventListener('click', closeModalCustom);
        window.addEventListener('click', (e) => {
            if (!avatar.contains(e.target) && !userMenu.contains(e.target)) userMenu.classList.remove('active');
        });
    </script>
</body>
</html>